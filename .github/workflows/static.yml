name: ðŸ“š Deploy Documentation

on:
  push:
    branches: [ main ]
    paths: 
      - 'docs/**'
      - '.github/workflows/docs.yml'
  pull_request:
    branches: [ main ]
    paths: 
      - 'docs/**'
  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

# è®¾ç½®æƒé™
permissions:
  contents: read
  pages: write
  id-token: write

# åªå…è®¸ä¸€ä¸ªéƒ¨ç½²åŒæ—¶è¿›è¡Œ
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  # æž„å»ºæ–‡æ¡£
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: ðŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: 'docs/package-lock.json'

    - name: ðŸ“¦ Install dependencies
      run: |
        cd docs
        npm ci || npm install

    - name: ðŸ”§ Setup Pages
      uses: actions/configure-pages@v4

    - name: ðŸ” Validate documentation
      run: |
        cd docs
        # æ£€æŸ¥å¿…è¦æ–‡ä»¶æ˜¯å¦å­˜åœ¨
        echo "ðŸ“‹ æ£€æŸ¥æ–‡æ¡£ç»“æž„..."
        test -f index.html || { echo "âŒ index.html not found"; exit 1; }
        test -f README.md || { echo "âŒ README.md not found"; exit 1; }
        test -f _sidebar.md || { echo "âŒ _sidebar.md not found"; exit 1; }
        test -f _navbar.md || { echo "âŒ _navbar.md not found"; exit 1; }
        test -f _coverpage.md || { echo "âŒ _coverpage.md not found"; exit 1; }
        
        # æ£€æŸ¥å…³é”®ç›®å½•
        test -d guide || { echo "âŒ guide directory not found"; exit 1; }
        test -d api || { echo "âŒ api directory not found"; exit 1; }
        test -d assets || { echo "âŒ assets directory not found"; exit 1; }
        
        echo "âœ… æ–‡æ¡£ç»“æž„éªŒè¯é€šè¿‡"

    - name: ðŸ”— Check links
      run: |
        cd docs
        echo "ðŸ” æ£€æŸ¥å†…éƒ¨é“¾æŽ¥..."
        # ç®€å•çš„é“¾æŽ¥æ£€æŸ¥ï¼ˆå¯ä»¥æ‰©å±•ä½¿ç”¨æ›´å¤æ‚çš„å·¥å…·ï¼‰
        if grep -r "\[.*\](.*\.md)" . | grep -v "http" | grep -v "#"; then
          echo "ðŸ“ æ‰¾åˆ°å†…éƒ¨é“¾æŽ¥ï¼Œæ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨..."
          # è¿™é‡Œå¯ä»¥æ·»åŠ æ›´è¯¦ç»†çš„é“¾æŽ¥æ£€æŸ¥é€»è¾‘
        fi
        echo "âœ… é“¾æŽ¥æ£€æŸ¥å®Œæˆ"

    - name: ðŸ› ï¸ Build documentation
      run: |
        cd docs
        echo "ðŸ—ï¸ æž„å»ºæ–‡æ¡£..."
        
        # å¦‚æžœæœ‰ build scriptï¼Œè¿è¡Œå®ƒ
        if [ -f package.json ] && npm run --silent 2>/dev/null | grep -q "build"; then
          npm run build
        fi
        
        # ç”Ÿæˆç«™ç‚¹åœ°å›¾
        echo "ðŸ“„ ç”Ÿæˆç«™ç‚¹åœ°å›¾..."
        cat > sitemap.xml << 'EOF'
        <?xml version="1.0" encoding="UTF-8"?>
        <urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9">
          <url>
            <loc>https://telegram-sdk.xbot.my/</loc>
            <changefreq>daily</changefreq>
            <priority>1.0</priority>
          </url>
          <url>
            <loc>https://telegram-sdk.xbot.my/#/guide/installation</loc>
            <changefreq>weekly</changefreq>
            <priority>0.8</priority>
          </url>
          <url>
            <loc>https://telegram-sdk.xbot.my/#/guide/quick-start</loc>
            <changefreq>weekly</changefreq>
            <priority>0.8</priority>
          </url>
          <url>
            <loc>https://telegram-sdk.xbot.my/#/guide/configuration</loc>
            <changefreq>weekly</changefreq>
            <priority>0.8</priority>
          </url>
          <url>
            <loc>https://telegram-sdk.xbot.my/#/api/</loc>
            <changefreq>weekly</changefreq>
            <priority>0.7</priority>
          </url>
        </urlset>
        EOF
        
        # ç”Ÿæˆ robots.txt
        echo "ðŸ¤– ç”Ÿæˆ robots.txt..."
        cat > robots.txt << 'EOF'
        User-agent: *
        Allow: /
        
        Sitemap: https://telegram-sdk.xbot.my/sitemap.xml
        EOF
        
        echo "âœ… æ–‡æ¡£æž„å»ºå®Œæˆ"

    - name: ðŸ“Š Generate build info
      run: |
        cd docs
        echo "ðŸ“‹ ç”Ÿæˆæž„å»ºä¿¡æ¯..."
        cat > build-info.json << EOF
        {
          "buildTime": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
          "commit": "${{ github.sha }}",
          "branch": "${{ github.ref_name }}",
          "workflow": "${{ github.workflow }}",
          "actor": "${{ github.actor }}"
        }
        EOF

    - name: ðŸ“¤ Upload artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: ./docs

  # éƒ¨ç½²åˆ° GitHub Pages
  deploy:
    if: github.ref == 'refs/heads/main'
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    
    steps:
    - name: ðŸš€ Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4

    - name: ðŸ“ Comment on PR
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `ðŸ“š æ–‡æ¡£é¢„è§ˆå·²éƒ¨ç½²ï¼\n\nðŸ”— é¢„è§ˆé“¾æŽ¥: ${{ steps.deployment.outputs.page_url }}\n\nâ° éƒ¨ç½²æ—¶é—´: ${new Date().toISOString()}`
          })

  # æž„å»ºçŠ¶æ€é€šçŸ¥
  notify:
    if: always()
    runs-on: ubuntu-latest
    needs: [build, deploy]
    
    steps:
    - name: ðŸ“Š Notify build status
      uses: actions/github-script@v7
      with:
        script: |
          const buildResult = '${{ needs.build.result }}';
          const deployResult = '${{ needs.deploy.result }}';
          
          let status = 'âœ… æˆåŠŸ';
          let emoji = 'ðŸŽ‰';
          
          if (buildResult === 'failure' || deployResult === 'failure') {
            status = 'âŒ å¤±è´¥';
            emoji = 'ðŸ’¥';
          } else if (buildResult === 'cancelled' || deployResult === 'cancelled') {
            status = 'â¹ï¸ å–æ¶ˆ';
            emoji = 'ðŸ›‘';
          }
          
          console.log(`${emoji} æ–‡æ¡£éƒ¨ç½²${status}`);
          
          // å¦‚æžœæœ‰ Slack webhook æˆ–å…¶ä»–é€šçŸ¥æ–¹å¼ï¼Œå¯ä»¥åœ¨è¿™é‡Œé…ç½®
          
  # æ¸…ç†æ—§çš„éƒ¨ç½²
  cleanup:
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    needs: deploy
    
    steps:
    - name: ðŸ§¹ Cleanup old deployments
      uses: actions/github-script@v7
      with:
        script: |
          // ä¿ç•™æœ€è¿‘ 5 ä¸ªéƒ¨ç½²
          const deployments = await github.rest.repos.listDeployments({
            owner: context.repo.owner,
            repo: context.repo.repo,
            environment: 'github-pages',
            per_page: 100
          });
          
          const deploymentsToDelete = deployments.data.slice(5);
          
          for (const deployment of deploymentsToDelete) {
            try {
              // é¦–å…ˆè®¾ç½®éƒ¨ç½²ä¸º inactive
              await github.rest.repos.createDeploymentStatus({
                owner: context.repo.owner,
                repo: context.repo.repo,
                deployment_id: deployment.id,
                state: 'inactive'
              });
              
              // ç„¶åŽåˆ é™¤éƒ¨ç½²
              await github.rest.repos.deleteDeployment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                deployment_id: deployment.id
              });
              
              console.log(`å·²åˆ é™¤éƒ¨ç½² ${deployment.id}`);
            } catch (error) {
              console.log(`åˆ é™¤éƒ¨ç½² ${deployment.id} å¤±è´¥: ${error.message}`);
            }
          }

  # æ€§èƒ½å’Œ SEO æ£€æŸ¥
  lighthouse:
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    needs: deploy
    
    steps:
    - name: ðŸ“¥ Checkout
      uses: actions/checkout@v4

    - name: ðŸ” Wait for deployment
      run: |
        echo "â³ ç­‰å¾…éƒ¨ç½²å®Œæˆ..."
        sleep 60

    - name: ðŸš¦ Lighthouse CI
      uses: treosh/lighthouse-ci-action@v10
      with:
        urls: |
          https://telegram-sdk.xbot.my
          https://telegram-sdk.xbot.my/#/guide/quick-start
          https://telegram-sdk.xbot.my/#/api/
        uploadArtifacts: true
        temporaryPublicStorage: true
