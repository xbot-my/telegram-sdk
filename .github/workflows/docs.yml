name: ðŸ“š Deploy Documentation

on:
  push:
    branches: [ main ]
    paths: 
      - 'docs/**'
      - '.github/workflows/docs.yml'
  pull_request:
    branches: [ main ]
    paths: 
      - 'docs/**'
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - name: ðŸ“¥ Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: ðŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: 'docs/package-lock.json'

    - name: ðŸ“¦ Install dependencies
      run: |
        cd docs
        if [ -f package-lock.json ]; then
          npm ci --prefer-offline --no-audit
        else
          npm install --prefer-offline --no-audit
        fi

    - name: ðŸ”§ Setup Pages
      uses: actions/configure-pages@v4

    - name: ðŸ” Validate documentation
      run: |
        cd docs
        echo "ðŸ“‹ æ£€æŸ¥æ–‡æ¡£ç»“æž„..."
        [ -f index.html ] || { echo "âŒ ç¼ºå°‘ index.html"; exit 1; }
        [ -f README.md ] || { echo "âŒ ç¼ºå°‘ README.md"; exit 1; }
        echo "âœ… æ–‡æ¡£ç»“æž„éªŒè¯å®Œæˆ"

    - name: ðŸ” Lint Markdown (strict)
      run: |
        cd docs
        echo "ðŸ“ Markdown linting..."
        npm run lint

    - name: ðŸ”— Check links (strict)
      run: |
        cd docs
        echo "ðŸ” æ£€æŸ¥æ–‡æ¡£é“¾æŽ¥..."
        npm run check-links

    - name: ðŸ› ï¸ Build documentation
      run: |
        cd docs
        echo "ðŸ—ï¸ docsify é™æ€ç«™ç‚¹ï¼Œæ— éœ€é¢å¤–æž„å»º"
        echo "ðŸ“„ ç”Ÿæˆ sitemap.xml ..."
        cat > sitemap.xml << 'EOF'
        <?xml version="1.0" encoding="UTF-8"?>
        <urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9">
          <url>
            <loc>https://telegram-sdk.xbot.my/</loc>
            <changefreq>daily</changefreq>
            <priority>1.0</priority>
          </url>
          <url>
            <loc>https://telegram-sdk.xbot.my/#/guide/installation</loc>
            <changefreq>weekly</changefreq>
            <priority>0.8</priority>
          </url>
          <url>
            <loc>https://telegram-sdk.xbot.my/#/guide/quick-start</loc>
            <changefreq>weekly</changefreq>
            <priority>0.8</priority>
          </url>
          <url>
            <loc>https://telegram-sdk.xbot.my/#/guide/configuration</loc>
            <changefreq>weekly</changefreq>
            <priority>0.8</priority>
          </url>
          <url>
            <loc>https://telegram-sdk.xbot.my/#/api/</loc>
            <changefreq>weekly</changefreq>
            <priority>0.7</priority>
          </url>
        </urlset>
        EOF
        echo "ðŸ¤– ç”Ÿæˆ robots.txt..."
        echo "User-agent: *\nAllow: /" > robots.txt
        echo "âœ… æ–‡æ¡£æž„å»ºå®Œæˆ"

    - name: ðŸ“Š Generate build info
      run: |
        cd docs
        cat > build-info.json << EOF
{
  "buildTime": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
  "commit": "${{ github.sha }}",
  "branch": "${{ github.ref_name }}",
  "workflow": "${{ github.workflow }}",
  "actor": "${{ github.actor }}"
}
EOF

    - name: ðŸ“¤ Upload artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: ./docs

    - name: ðŸ“ Comment on PR
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `ðŸ“š æ–‡æ¡£æž„å»ºå®Œæˆ âœ…\n\næäº¤: \`${{ github.sha }}\`\nåˆ†æ”¯: \`${{ github.ref_name }}\`\nè§¦å‘è€…: @${{ github.actor }}`
          })

  deploy:
    if: github.ref == 'refs/heads/main'
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
    - name: ðŸš€ Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4

  lighthouse:
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    needs: deploy
    steps:
    - name: ðŸš¦ Lighthouse CI
      uses: treosh/lighthouse-ci-action@v10
      continue-on-error: true
      with:
        urls: |
          https://telegram-sdk.xbot.my
          https://telegram-sdk.xbot.my/#/guide/quick-start
          https://telegram-sdk.xbot.my/#/api/
        uploadArtifacts: true
        temporaryPublicStorage: true

    - name: ðŸ“Š Report Lighthouse summary
      run: |
        echo "ðŸ“Š Lighthouse ç»“æžœå·²ä¸Šä¼ åˆ° Artifact"
        echo "ðŸ‘‰ è¯·åœ¨ Actions é¡µé¢ä¸‹è½½æŸ¥çœ‹å®Œæ•´æŠ¥å‘Š"