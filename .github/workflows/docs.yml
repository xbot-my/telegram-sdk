name: ğŸ“š Deploy Documentation

on:
  push:
    branches: [ main ]
    paths: 
      - 'docs/**'
      - '.github/workflows/docs.yml'
  pull_request:
    branches: [ main ]
    paths: 
      - 'docs/**'
  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

# è®¾ç½®æƒé™
permissions:
  contents: read
  pages: write
  id-token: write

# åªå…è®¸ä¸€ä¸ªéƒ¨ç½²åŒæ—¶è¿›è¡Œ
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  # æ„å»ºæ–‡æ¡£
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: 'docs/package-lock.json'

    - name: ğŸ“¦ Install dependencies
      run: |
        cd docs
        # ä½¿ç”¨npm ciè·å¾—æ›´å¥½çš„æ€§èƒ½å’Œå¯é æ€§
        if [ -f package-lock.json ]; then
          npm ci --prefer-offline --no-audit
        else
          npm install --prefer-offline --no-audit
        fi

    - name: ğŸ”§ Setup Pages
      uses: actions/configure-pages@v4

    - name: ğŸ” Validate documentation
      run: |
        cd docs
        echo "ğŸ“‹ æ£€æŸ¥æ–‡æ¡£ç»“æ„..."
        
        # æ£€æŸ¥å¿…è¦æ–‡ä»¶ï¼Œä½†ä¸ä¼šå› ä¸ºå•ä¸ªæ–‡ä»¶ç¼ºå¤±è€Œå¤±è´¥
        missing_files=()
        
        [ ! -f index.html ] && missing_files+=("index.html")
        [ ! -f README.md ] && missing_files+=("README.md")
        [ ! -f _sidebar.md ] && missing_files+=("_sidebar.md")
        [ ! -f _navbar.md ] && missing_files+=("_navbar.md")
        [ ! -f _coverpage.md ] && missing_files+=("_coverpage.md")
        
        if [ ${#missing_files[@]} -gt 0 ]; then
          echo "âš ï¸ ç¼ºå°‘æ–‡ä»¶: ${missing_files[*]}"
          # åªåœ¨ç¼ºå°‘å…³é”®æ–‡ä»¶æ—¶æ‰å¤±è´¥
          if [ ! -f index.html ] || [ ! -f README.md ]; then
            echo "âŒ å…³é”®æ–‡ä»¶ç¼ºå¤±ï¼Œæ„å»ºå¤±è´¥"
            exit 1
          fi
        fi
        
        # æ£€æŸ¥å…³é”®ç›®å½•
        missing_dirs=()
        [ ! -d guide ] && missing_dirs+=("guide")
        [ ! -d api ] && missing_dirs+=("api")
        [ ! -d assets ] && missing_dirs+=("assets")
        
        if [ ${#missing_dirs[@]} -gt 0 ]; then
          echo "âš ï¸ ç¼ºå°‘ç›®å½•: ${missing_dirs[*]}"
        fi
        
        echo "âœ… æ–‡æ¡£ç»“æ„éªŒè¯å®Œæˆ"

    - name: ğŸ” Lint Markdown
      run: |
        cd docs
        echo "ğŸ“ æ£€æŸ¥Markdownæ ¼å¼..."
        # ä½¿ç”¨markdownlintæ£€æŸ¥æ–‡æ¡£æ ¼å¼
        npm run lint || {
          echo "âš ï¸ Markdownæ ¼å¼æ£€æŸ¥å‘ç°é—®é¢˜ï¼Œä½†ä¸é˜»å¡æ„å»º"
          npm run lint:fix 2>/dev/null || true
        }
        echo "âœ… Markdownæ£€æŸ¥å®Œæˆ"

    - name: ğŸ”— Check links
      run: |
        cd docs
        echo "ğŸ” æ£€æŸ¥æ–‡æ¡£é“¾æ¥..."
        
        # ä½¿ç”¨markdown-link-checkè¿›è¡Œæ›´å…¨é¢çš„é“¾æ¥æ£€æŸ¥
        npm run check-links || {
          echo "âš ï¸ å‘ç°æŸåçš„é“¾æ¥ï¼Œä½†ä¸é˜»å¡æ„å»º"
          echo "ğŸ“ è¯·æ£€æŸ¥ä¸Šé¢çš„é”™è¯¯ä¿¡æ¯å¹¶ä¿®å¤æŸåçš„é“¾æ¥"
        }
        
        # æ£…æŸ¥å†…éƒ¨æ–‡ä»¶å¼•ç”¨
        echo "ğŸ“ æ£€æŸ¥å†…éƒ¨æ–‡ä»¶å¼•ç”¨..."
        find . -name "*.md" -exec grep -l "\](.*\.md)" {} \; | while read file; do
          echo "æ£€æŸ¥æ–‡ä»¶: $file"
          grep -o "\](.*\.md)" "$file" | sed 's/](//' | sed 's/)//' | while read link; do
            if [[ ! "$link" =~ ^http ]]; then
              target="$(dirname "$file")/$link"
              if [[ ! -f "$target" ]]; then
                echo "âš ï¸ åœ¨ $file ä¸­å‘ç°æŸåçš„å†…éƒ¨é“¾æ¥: $link"
              fi
            fi
          done
        done
        
        echo "âœ… é“¾æ¥æ£€æŸ¥å®Œæˆ"

    - name: ğŸ› ï¸ Build documentation
      run: |
        cd docs
        echo "ğŸ—ï¸ æ„å»ºæ–‡æ¡£..."
        
        # ä¼˜åŒ–èµ„æºï¼ˆéå…³é”®æ­¥éª¤ï¼Œå¤±è´¥ä¸å½±å“æ•´ä½“æ„å»ºï¼‰
        echo "ğŸ‡¿ï¸ ä¼˜åŒ–èµ„æº..."
        npm run optimize 2>/dev/null || {
          echo "âš ï¸ èµ„æºä¼˜åŒ–å¤±è´¥ï¼Œä½†ä¸å½±å“æ„å»º"
        }
        
        # docsifyæ˜¯çº¯é™æ€ç«™ç‚¹ï¼Œä¸éœ€è¦å¤æ‚æ„å»º
        echo "ğŸ“ docsifyé™æ€ç«™ç‚¹ï¼Œæ— éœ€æ„å»ºæ­¥éª¤"
        
        # ç”Ÿæˆç«™ç‚¹åœ°å›¾
        echo "ğŸ“„ ç”Ÿæˆç«™ç‚¹åœ°å›¾..."
        cat > sitemap.xml << 'EOF'
        <?xml version="1.0" encoding="UTF-8"?>
        <urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9">
          <url>
            <loc>https://telegram-sdk.xbot.my/</loc>
            <changefreq>daily</changefreq>
            <priority>1.0</priority>
          </url>
          <url>
            <loc>https://telegram-sdk.xbot.my/#/guide/installation</loc>
            <changefreq>weekly</changefreq>
            <priority>0.8</priority>
          </url>
          <url>
            <loc>https://telegram-sdk.xbot.my/#/guide/quick-start</loc>
            <changefreq>weekly</changefreq>
            <priority>0.8</priority>
          </url>
          <url>
            <loc>https://telegram-sdk.xbot.my/#/guide/configuration</loc>
            <changefreq>weekly</changefreq>
            <priority>0.8</priority>
          </url>
          <url>
            <loc>https://telegram-sdk.xbot.my/#/api/</loc>
            <changefreq>weekly</changefreq>
            <priority>0.7</priority>
          </url>
        </urlset>
        EOF
        
        # ç”Ÿæˆ robots.txt
        echo "ğŸ¤– ç”Ÿæˆ robots.txt..."
        cat > robots.txt << 'EOF'
User-agent: *
Allow: /

Sitemap: https://telegram-sdk.xbot.my/sitemap.xml
EOF
        
        echo "âœ… æ–‡æ¡£æ„å»ºå®Œæˆ"

    - name: ğŸ“Š Generate build info
      run: |
        cd docs
        echo "ğŸ“‹ ç”Ÿæˆæ„å»ºä¿¡æ¯..."
        cat > build-info.json << EOF
{
  "buildTime": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
  "commit": "${{ github.sha }}",
  "branch": "${{ github.ref_name }}",
  "workflow": "${{ github.workflow }}",
  "actor": "${{ github.actor }}"
}
EOF

    - name: ğŸ“¤ Upload artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: ./docs

    - name: ğŸ“ Comment on PR
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `ğŸ“š æ–‡æ¡£æ„å»ºå®Œæˆï¼\n\nğŸ“‹ æ„å»ºä¿¡æ¯:\n- æäº¤: \`${{ github.sha }}\`\n- åˆ†æ”¯: \`${{ github.ref_name }}\`\n- è§¦å‘è€…: @${{ github.actor }}\n\nâ° æ„å»ºæ—¶é—´: ${new Date().toISOString()}`
          })

  # éƒ¨ç½²åˆ° GitHub Pages
  deploy:
    if: github.ref == 'refs/heads/main'
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    
    steps:
    - name: ğŸš€ Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4

  # æ„å»ºçŠ¶æ€é€šçŸ¥
  notify:
    if: always()
    runs-on: ubuntu-latest
    needs: [build, deploy]
    
    steps:
    - name: ğŸ“Š Notify build status
      uses: actions/github-script@v7
      with:
        retries: 3
        retry-exempt-status-codes: 400,401,403,404,422
        script: |
          const buildResult = '${{ needs.build.result }}';
          const deployResult = '${{ needs.deploy.result }}';
          
          let status = 'âœ… æˆåŠŸ';
          let emoji = 'ğŸ‰';
          let details = [];
          
          if (buildResult === 'failure') {
            status = 'âŒ æ„å»ºå¤±è´¥';
            emoji = 'ğŸ’¥';
            details.push('æ„å»ºé˜¶æ®µå¤±è´¥');
          } else if (deployResult === 'failure') {
            status = 'âŒ éƒ¨ç½²å¤±è´¥';
            emoji = 'ğŸ’¥';
            details.push('éƒ¨ç½²é˜¶æ®µå¤±è´¥');
          } else if (buildResult === 'cancelled' || deployResult === 'cancelled') {
            status = 'â¹ï¸ å–æ¶ˆ';
            emoji = 'ğŸ›‘';
            details.push('å·¥ä½œæµè¢«å–æ¶ˆ');
          } else if (buildResult === 'success' && deployResult === 'success') {
            details.push('æ„å»ºå’Œéƒ¨ç½²å‡æˆåŠŸ');
          } else if (buildResult === 'success' && deployResult === 'skipped') {
            details.push('æ„å»ºæˆåŠŸï¼Œéƒ¨ç½²è¢«è·³è¿‡ï¼ˆéä¸»åˆ†æ”¯ï¼‰');
          }
          
          const message = `${emoji} æ–‡æ¡£å·¥ä½œæµ${status}`;
          console.log(message);
          
          if (details.length > 0) {
            console.log('è¯¦ç»†ä¿¡æ¯: ' + details.join(', '));
          }
          
          // è®°å½•æ„å»ºç»Ÿè®¡
          console.log('æ„å»ºç»Ÿè®¡:');
          console.log(`- æäº¤: ${{ github.sha }}`);
          console.log(`- åˆ†æ”¯: ${{ github.ref_name }}`);
          console.log(`- è§¦å‘äº‹ä»¶: ${{ github.event_name }}`);
          console.log(`- æ‰§è¡Œè€…: ${{ github.actor }}`);
          
          // å¦‚æœæœ‰ Slack webhook æˆ–å…¶ä»–é€šçŸ¥æ–¹å¼ï¼Œå¯ä»¥åœ¨è¿™é‡Œé…ç½®
          // ä¾‹å¦‚ï¼š
          // if (process.env.SLACK_WEBHOOK_URL) {
          //   await fetch(process.env.SLACK_WEBHOOK_URL, {
          //     method: 'POST',
          //     headers: { 'Content-Type': 'application/json' },
          //     body: JSON.stringify({ text: message })
          //   });
          // }
          
  # æ¸…ç†æ—§çš„éƒ¨ç½²
  cleanup:
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    needs: deploy
    
    steps:
    - name: ğŸ§¹ Cleanup old deployments
      uses: actions/github-script@v7
      with:
        retries: 2
        script: |
          console.log('ğŸ—½ï¸ å¼€å§‹æ¸…ç†æ—§éƒ¨ç½²...');
          
          try {
            // è·å–æ‰€æœ‰éƒ¨ç½²
            const deployments = await github.rest.repos.listDeployments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              environment: 'github-pages',
              per_page: 100
            });
            
            console.log(`ğŸ“‹ æ‰¾åˆ° ${deployments.data.length} ä¸ªéƒ¨ç½²`);
            
            // ä¿ç•™æœ€è¿‘ 5 ä¸ªéƒ¨ç½²
            const deploymentsToDelete = deployments.data.slice(5);
            
            if (deploymentsToDelete.length === 0) {
              console.log('âœ… æ— éœ€æ¸…ç†ï¼Œéƒ¨ç½²æ•°é‡åœ¨åˆç†èŒƒå›´å†…');
              return;
            }
            
            console.log(`ğŸ—½ï¸ å°†åˆ é™¤ ${deploymentsToDelete.length} ä¸ªæ—§éƒ¨ç½²`);
            
            let deletedCount = 0;
            let failedCount = 0;
            
            for (const deployment of deploymentsToDelete) {
              try {
                // é¦–å…ˆè®¾ç½®éƒ¨ç½²ä¸º inactive
                await github.rest.repos.createDeploymentStatus({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  deployment_id: deployment.id,
                  state: 'inactive'
                });
                
                // ç„¶ååˆ é™¤éƒ¨ç½²
                await github.rest.repos.deleteDeployment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  deployment_id: deployment.id
                });
                
                console.log(`âœ… å·²åˆ é™¤éƒ¨ç½² ${deployment.id} (${deployment.created_at})`);
                deletedCount++;
              } catch (error) {
                console.log(`âŒ åˆ é™¤éƒ¨ç½² ${deployment.id} å¤±è´¥: ${error.message}`);
                failedCount++;
              }
            }
            
            console.log(`ğŸ“Š æ¸…ç†ç»Ÿè®¡: æˆåŠŸ ${deletedCount} ä¸ª, å¤±è´¥ ${failedCount} ä¸ª`);
            
          } catch (error) {
            console.log(`âŒ æ¸…ç†è¿‡ç¨‹å¤±è´¥: ${error.message}`);
            // ä¸æŠ›å‡ºé”™è¯¯ï¼Œå› ä¸ºæ¸…ç†å¤±è´¥ä¸åº”å½±å“ä¸»è¦éƒ¨ç½²æµç¨‹
          }

  # æ€§èƒ½å’Œ SEO æ£€æŸ¥
  lighthouse:
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    needs: deploy
    
    steps:
    - name: ğŸ“¥ Checkout
      uses: actions/checkout@v4

    - name: ğŸ” Wait for deployment
      run: |
        echo "â³ ç­‰å¾…éƒ¨ç½²å®Œæˆ..."
        # ç­‰å¾…ç«™ç‚¹å¯è®¿é—®
        max_attempts=10
        attempt=1
        
        while [ $attempt -le $max_attempts ]; do
          echo "ğŸ”„ ç¬¬ $attempt æ¬¡å°è¯•æ£€æŸ¥ç«™ç‚¹å¯è®¿é—®æ€§..."
          
          if curl -s -f "https://telegram-sdk.xbot.my" > /dev/null; then
            echo "âœ… ç«™ç‚¹å·²å¯è®¿é—®"
            break
          else
            echo "âš ï¸ ç«™ç‚¹ä¸å¯è®¿é—®ï¼Œç­‰å¾…15ç§’åé‡è¯•..."
            sleep 15
          fi
          
          if [ $attempt -eq $max_attempts ]; then
            echo "âŒ ç«™ç‚¹åœ¨è¶…æ—¶åä»ä¸å¯è®¿é—®ï¼Œè·³è¿‡Lighthouseæ£€æŸ¥"
            exit 0
          fi
          
          attempt=$((attempt + 1))
        done

    - name: ğŸš¦ Lighthouse CI
      uses: treosh/lighthouse-ci-action@v10
      continue-on-error: true
      with:
        urls: |
          https://telegram-sdk.xbot.my
          https://telegram-sdk.xbot.my/#/guide/quick-start
          https://telegram-sdk.xbot.my/#/api/
        uploadArtifacts: true
        temporaryPublicStorage: true

    - name: ğŸ“Š Report Lighthouse results
      if: always()
      run: |
        echo "ğŸ“Š Lighthouseæ€§èƒ½æ£€æŸ¥å®Œæˆ"
        echo "ğŸ“ ç»“æœå·²ä¸Šä¼ åˆ°GitHub Artifactsï¼Œå¯åœ¨Actionsé¡µé¢æŸ¥çœ‹"
